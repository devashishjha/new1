
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users Collection
    // - Anyone can view a user's public profile.
    // - Only an authenticated user can create or update their own profile document.
    match /users/{userId} {
      allow read: if true;
      allow create, update: if request.auth != null && request.auth.uid == userId;
      // Deletion is generally disabled to prevent orphaned data.
      allow delete: if false; 
    }

    // Properties Collection
    // - Anyone can view properties.
    // - Authenticated users can create properties, but must set themselves as the lister.
    // - Only the original lister can update or delete their property.
    match /properties/{propertyId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.lister.id == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.lister.id == request.auth.uid;
    }

    // Chats Collection
    // - Only participants can read, create, or update a chat.
    match /chats/{chatId} {
      allow read, update, delete: if request.auth != null && request.auth.uid in resource.data.participantIds;
      // On create, ensure the user creating the chat is a participant and the structure is correct.
      allow create: if request.auth != null && request.auth.uid in request.resource.data.participantIds && request.resource.data.participantIds.size() == 2;
    }
  }
}
